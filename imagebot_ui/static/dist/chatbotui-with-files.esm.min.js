/*!
 * @license MIT
 * Copyright 2024 prognostica GmbH
 */
class e{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;s?this.element=s:(this.element=document.createElement(e),this.element.dataset.chatbotuiType="BaseComponent",this.setTimestamp(t),this.isDragging=!1,this.startX=0,this.startY=0,this.element.addEventListener("mousedown",(e=>this.onMouseDown(e))),document.addEventListener("mousemove",(e=>this.onMouseMove(e))),document.addEventListener("mouseup",(e=>this.onMouseUp(e))))}onMouseDown(e){this.isDragging=!1,this.startX=e.clientX,this.startY=e.clientY}onMouseMove(e){(Math.abs(e.clientX-this.startX)>5||Math.abs(e.clientY-this.startY)>5)&&(this.isDragging=!0)}onMouseUp(e){this.isDragging||this.toggleSelected()}toggleSelected(){this.setSelected(!this.isSelected())}setSelected(e){this.element.dataset.chatbotuiSelected=e}isSelected(){return"true"===this.element.dataset.chatbotuiSelected}setTimestamp(e){this.element.dataset.chatbotuiTimestamp=e.getTime(),this.element.dataset.chatbotuiTimestampLocale=e.toLocaleString()}}let t=e=>e;function s(e){t=e}class i extends e{static _messageCounter=0;constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];super("div",t),this.#e(i._messageCounter++),this.element.dataset.chatbotuiType="Message",this.setRole(e),this.files=s}getMessageItem(e){const t=this.element.querySelector(`[data-chatbotui-message-item-id="${e}"]`);if(t)return new n(void 0,void 0,void 0,void 0,void 0,t)}deleteMessageItem(e){const t=this.element.querySelector(`[data-chatbotui-message-item-id="${e}"]`);return!!t&&(this.element.removeChild(t),!0)}hideMessageItem(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const s=this.getMessageItem(e);return!!s&&(s.setHidden(t),!0)}getMessageItems(){return Array.from(this.element.querySelectorAll('[data-chatbotui-type="MessageItem"]')).map((e=>new n(void 0,void 0,void 0,void 0,void 0,e)))}#e(e){this.element.dataset.chatbotuiMessageId=e}getMessageID(){return parseInt(this.element.dataset.chatbotuiMessageId,10)}setRole(e){this.element.dataset.chatbotuiMessageRole=e}getElement(){return this.element}addMessageItem(e){this.element.appendChild(e.getElement())}displayFiles(){if(0==this.files.length)return;const e=document.createElement("div");e.className="message-file-area",this.files.forEach((t=>{e.appendChild(t.element)})),this.element.appendChild(e)}}class n extends e{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,n=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Date,a=arguments.length>5?arguments[5]:void 0;super("div",n,a),a||(this.#t(e),this.element.dataset.chatbotuiType="MessageItem",this.setType(t),i&&this.setName(i),this.setActive(s))}#t(e){this.id=e,this.getElement().dataset.chatbotuiMessageItemId=e}setActive(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?this.getElement().dataset.chatbotuiMessageItemActive=e:delete this.getElement().dataset.chatbotuiMessageItemActive}setHidden(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?this.getElement().dataset.chatbotuiMessageItemHidden=e:delete this.getElement().dataset.chatbotuiMessageItemHidden}getElement(){return this.element}setType(e){this.element.dataset.chatbotuiMessageItemType=e}setName(e){this.element.dataset.chatbotuiMessageItemName=e}setHTML(e){this.element.innerHTML=e}setMarkdown(e){this.setHTML(t(e))}withMarkdown(e){return this.setHTML(t(e)),this}setPlaintext(e){this.element.innerText=e}withPlaintext(e){return this.setPlaintext(e),this}}let a=[];const r=e=>{for(const t of a){const s=t(e);if(s)return s}},o=e=>{a.push(e)},h=e=>{if("ChatInput"===e.dataset.chatbotuiType){return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/div>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<[^>]+>/g,"")}},l=e=>{if("InputFileArea"===e.dataset.chatbotuiType){const t=e.querySelectorAll('[data-chatbotui-type="InputFile"][data-chatbotui-input-file-id]'),s=[];for(const e of t)s.push(e.dataset.chatbotuiInputFileId);return s}};class c{constructor(){this.mediaStream=null,this.mediaRecorder=null,this.recording=null,this.recording=null}async startRecording(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({audio:!0}),this.mediaRecorder=new MediaRecorder(this.mediaStream,{audioBitsPerSecond:16e3}),this.mediaRecorder.ondataavailable=e=>{this.recording=e.data},this.mediaRecorder.start()}catch(e){console.error("Error accessing microphone:",e)}}async stopRecording(){if(this.mediaRecorder&&"inactive"!==this.mediaRecorder.state)return new Promise((e=>{this.mediaRecorder.onstop=async()=>{const t=new Blob([this.recording],{type:"audio/wav"}),s=await(i=t,new Promise(((e,t)=>{const s=new FileReader;s.readAsDataURL(i),s.onloadend=()=>{e(s.result.split(",")[1])},s.onerror=e=>t(e)})));var i,n;(n=this.mediaStream)&&n.getTracks().forEach((e=>{e.stop()})),e(s)},this.mediaRecorder.stop()}))}}const d=Object.freeze({TEXT:"text",AUDIO:"audio"});class u extends e{constructor(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,n=arguments.length>4&&void 0!==arguments[4]&&arguments[4];super("div"),this.element.dataset.chatbotuiType="ChatBar",this.notifyError=e,this.createGenerator=t,this.processor=s,this.sendInput=async()=>{if(this.isEnabled()&&!this.isRunning()){const e=this.getChatInput().element.innerText.trim(),t=i?i.getInputFileArea().getChildren():[];if(""!==e){this.setRunning(!0);const e=this.getInputData();document.dispatchEvent(new CustomEvent("chatbotuiMessageSendEvent",{detail:{inputType:d.TEXT}})),await this.send(e,"text",t),this.setRunning(!1),this.checkEnabled()}}},this.chatInput=new m(this.sendInput,i),this.chatSendButton=new g(this.sendInput),this.element.appendChild(this.chatInput.getElement()),this.element.appendChild(this.chatSendButton.getElement()),this.isRecording=!1,n?(this.sendVoiceInput=async e=>{if(!this.isRunning()){const t=i?i.getInputFileArea().getChildren():[];this.setRunning(!0),this.isRecording=!0,document.dispatchEvent(new CustomEvent("chatbotuiMessageSendEvent",{detail:{inputType:d.AUDIO}})),await this.send(e,"audio",t),this.setRunning(!1),this.isRecording=!1,this.checkEnabled()}},this.voiceRecordButton=n?new p(this.sendVoiceInput,this.processor.getAudioPlayer()):null,this.element.appendChild(this.voiceRecordButton.getElement()),this.voiceRecordButton.element.addEventListener("recordingStarted",(()=>{this.isRecording=!0,this.setEnabled(!1)})),this.voiceRecordButton.element.addEventListener("recordingStopped",(()=>{this.isRecording=!1,this.setEnabled(!0)})),this.processor.getAudioPlayer().addEventListener("playingAudioStarted",(()=>{this.voiceRecordButton.setPlaying(!0)})),this.processor.getAudioPlayer().addEventListener("playingAudioStopped",(()=>{this.voiceRecordButton.setPlaying(!1)}))):this.voiceRecordButton=null,this.setupChatInputObserver(),this.setRunning(!1),this.setEnabled(!1)}async send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:d.TEXT,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];const i="text"===t?e["chat-input"]:"ðŸŽ¤ [Voice Recording]";let n;this.processor.processUserMessage(i,s);try{n=await this.createGenerator(e,t)}catch(e){return console.error(e),void this.notifyError("Failed to send message.")}try{await this.processor.process(n)}catch(e){return console.error(e),void this.notifyError("Failure during message processing.")}}getChatInput(){return this.chatInput}setRunning(e){this.getElement().dataset.chatbotuiRunning=e}isRunning(){return"true"===this.getElement().dataset.chatbotuiRunning}getChatSendButton(){return this.chatSendButton}setEnabled(e){this.getChatSendButton().getElement().disabled=!e||this.isRecording}isEnabled(){return!this.getChatSendButton().getElement().disabled}checkEnabled(){const e=!this.isRunning(),t=""!==this.getChatInput().getElement().innerText.trim();this.setEnabled(e&&t)}setupChatInputObserver(){new MutationObserver((()=>this.checkEnabled())).observe(this.getChatInput().getElement(),{childList:!0,subtree:!0,characterData:!0})}getElement(){return this.element}getInputData(){const e={};for(const t of this.element.querySelectorAll("[data-chatbotui-type]")){const s=r(t);s&&(e[t.dataset.chatbotuiType.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()]=s)}return e}}class m extends e{constructor(e,t){super("div"),this.fileHandler=t,this.isComposing=!1;let s=!1;this.element.addEventListener("keydown",(t=>{"Shift"===t.key&&(s=!0),"Enter"!==t.key||t.isComposing||s||(t.preventDefault(),e())})),this.element.addEventListener("keyup",(e=>{"Shift"===e.key&&(s=!1)})),this.element.addEventListener("compositionstart",(()=>{this.isComposing=!0})),this.element.addEventListener("compositionend",(()=>{this.isComposing=!1})),document.addEventListener("chatbotuiMessageSendEvent",(e=>{e.detail.inputType===d.TEXT&&this.clear()})),this.element.contentEditable=!0,this.setupPasteHandler(),this.element.dataset.chatbotuiType="ChatInput"}setupMutationObserver(){new MutationObserver((()=>{!this.element.innerHTML.endsWith("<br><br>")&&this.element.innerHTML.endsWith("<br>")&&(this.element.innerHTML=this.element.innerHTML.slice(0,-4),this.#s())})).observe(this.element,{childList:!0,characterData:!0,subtree:!0})}setupPasteHandler(){this.element.addEventListener("paste",(async e=>{e.preventDefault();const t=e.clipboardData||window.clipboardData;if(!t)return;const s=t.getData("text/plain");if(s){const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0);t.deleteContents();const i=document.createTextNode(s);t.insertNode(i),t.setStartAfter(i),e.removeAllRanges(),e.addRange(t)}if(this.fileHandler){const e=t.items;for(let t=0;t<e.length;t++){const s=e[t].getAsFile();s&&this.fileHandler.attachFile(s)}}}))}clear(){this.element.innerHTML=""}#s(){this.element.focus();const e=this.element.ownerDocument.createRange();e.selectNodeContents(this.element),e.collapse(!1);const t=this.element.ownerDocument.defaultView.getSelection();t.removeAllRanges(),t.addRange(e)}getElement(){return this.element}}class g extends e{constructor(e){super("button"),this.element.innerHTML="send",this.element.dataset.chatbotuiType="ChatSendButton",this.element.onclick=e}getElement(){return this.element}}class p extends e{constructor(e,t){super("button"),this.element.dataset.chatbotuiType="VoiceRecordButton",this.send=e,this.audioPlayer=t,this.recorder=new c,this.isRecording=!1,this.isPlaying=!1,this.element.onclick=this.handleClick.bind(this)}async handleClick(){if(this.isPlaying)this.element.classList.remove("playing"),this.isPlaying=!1,this.audioPlayer.stop();else if(this.isRecording=!this.isRecording,this.isRecording)this.element.dispatchEvent(new CustomEvent("recordingStarted")),this.element.classList.add("recording"),this.recorder.startRecording();else{this.element.dispatchEvent(new CustomEvent("recordingStopped")),this.element.classList.remove("recording");const e=await this.recorder.stopRecording();this.send(e)}}getElement(){return this.element}setPlaying(e){e?(this.element.classList.add("playing"),this.isPlaying=!0):(this.element.classList.remove("playing"),this.isPlaying=!1)}}class v{constructor(){this.callbacks=new Set}register(e){if("function"!=typeof e)throw new Error("Callback must be a function");this.callbacks.add(e)}unregister(e){this.callbacks.delete(e)}callback(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.callbacks.forEach((e=>{try{e(...t)}catch(e){console.error("Callback error:",e)}}))}}const b=Object.freeze({TEXT:"text",TOOL:"tool",B64IMAGE:"b64image"});class E{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"N/A";this.type=e,this.content=t,this.messageItemID=s,this.type!==b.TEXT&&(this.name=i)}static fromJSON(e){const{content:t,messageItemID:s,type:i,name:n}=e;return new E(i,t,s,n)}}class I{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:b.TEXT,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.content=e,this.messageItemID=t,this.type=s,this.type!==b.TEXT&&(this.name=i)}static fromJSON(e){const{type:t,content:s,messageItemID:i,name:n}=e;return new I(s,i,t,n)}}class y{constructor(e,t,s){this.title=e,this.content=t,this.icon=s}static fromJSON(e){const{title:t,content:s,icon:i}=e;return new y(t,s,i)}}class w{constructor(e){this.content=e}static fromJSON(e){const{content:t}=e;return new w(t)}play(){this.audio=new Audio,this.audio.src="data:audio/wav;base64,"+this.content,this.audio.play()}pause(){this.audio&&this.audio.pause()}}class f{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;this.messageItemID=e}static fromJSON(e){const{messageItemID:t}=e;return new f(t)}}class C{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;this.messageItemID=e}static fromJSON(e){const{messageItemID:t}=e;return new C(t)}}const M=e=>((e,t)=>{let s=!1;return function(){s||(s=!0,e(...arguments),setTimeout((()=>{s=!1}),t))}})((()=>{e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}),500);class T{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.messageID=e,this.icon=s,this.title=i,this.content=t}}class R{constructor(){this.audio=null,this.listeners={}}play(e){this.audio||(this.audio=new Audio,this.audio.src="data:audio/wav;base64,"+e,this.audio.onended=()=>{this.dispatchEvent(new CustomEvent("playingAudioStopped")),this.audio=null}),this.audio.play(),this.dispatchEvent(new CustomEvent("playingAudioStarted"))}pause(){this.audio&&this.audio.pause()}resume(){this.audio&&this.audio.play()}stop(){this.audio&&(this.audio.pause(),this.audio=null),this.dispatchEvent(new CustomEvent("playingAudioStopped"))}addEventListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}dispatchEvent(e){this.listeners[e.type]&&this.listeners[e.type].forEach((t=>t(e))),this.audio&&this.audio.dispatchEvent(e)}}class D{constructor(e,t){this.messageContainer=e,this.documentCallback=t,this.scrollDown=M(e,e.parentElement),this.audioPlayer=new R}processUserMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const s=new i("user",new Date,t);s.addMessageItem(new n("text").withPlaintext(e)),s.displayFiles(),this.messageContainer.appendChild(s.getElement())}async process(e){const t=new i("assistant");this.messageContainer.appendChild(t.getElement()),this.scrollDown();try{await this.#i(t,e)}catch(e){const s=new n("error","text",!1);throw s.setMarkdown("*Error with response. Please try again later.*"),t.addMessageItem(s),this.#n(t),e}this.#n(t)}#n(e){e.getMessageItems().forEach((e=>{e.setActive(!1)})),setTimeout((()=>this.scrollDown()),500)}async#i(e,t){let s=null,i="";for await(const a of t){switch(a.constructor){case E:if(e.getMessageItem(a.messageItemID))throw new Error("Item already exists");case I:{const t=a.type===b.TOOL?a.name??"N/A":void 0;let r=e.getMessageItem(a.messageItemID);r||(r=new n(a.messageItemID,a.type,!0,t),r.setSelected(!0),i="",s&&s.setActive(!1),s=r,e.addMessageItem(r)),i+=a.content,r.setMarkdown(i);break}case y:{const t=new T(e.getMessageID(),a.content,a.icon,a.title);this.documentCallback(t);break}case w:{let e=new w(a.content);this.audioPlayer.play(e.content);break}case f:e.deleteMessageItem(a.messageItemID);case C:e.hideMessageItem(a.messageItemID);default:console.warn("Unknown data type received:",a)}this.scrollDown()}}stopAudio(){this.audioPlayer.stop()}getAudioPlayer(){return this.audioPlayer}}class S{static singleton=null;constructor(e){this.setStreamFunction(e),this.documentCallbackHandler=new v,this.errorCallbackHandler=new v,o(h),S.singleton=this}setRender(e){s(e)}withRender(e){return this.setRender(e),this}withSessionID(e){return this.sessionID=e,this}withStreamFunction(e){return this.streamFunction=e,this}setStreamFunction(e){this.streamFunction=e}withDocumentCallback(e){return this.documentCallbackHandler.register(e),this}withErrorCallback(e){return this.errorCallbackHandler.register(e),this}notifyError(e){this.errorCallbackHandler.callback(e)}_buildChatbar(){var e=this;this.chatBar=new u((e=>this.notifyError(e)),this.streamFunction,new D(this.messageContainer,(function(){return e.documentCallbackHandler.callback(...arguments)})))}attachTo(e,t){return this.messageContainer=e,this.chatbarContainer=t,this._buildChatbar(),this.#a(),t.appendChild(this.chatBar.getElement()),this}focus(){this.chatBar.getChatInput().getElement().focus()}#a(){const e=this.chatbarContainer.dataset.chatbotuiInputPlaceholder;e&&(this.chatBar.getChatInput().getElement().dataset.chatbotuiInputPlaceholder=e)}}class F extends e{constructor(e,t,s){super("div",void 0,s),s||(this.element.dataset.chatbotuiType="InputFile",this.setName(e),this.element.onclick=e=>{e.stopPropagation(),this.element.dataset.chatbotuiInputFileId&&(t(this.element.dataset.chatbotuiInputFileId),this.element.remove())},this.preview=document.createElement("img"),this.preview.classList.add("file-preview"),this.element.insertBefore(this.preview,this.element.firstChild))}setName(e){this.element.dataset.chatbotuiInputFileName=e}setID(e){this.element.dataset.chatbotuiInputFileId=e}setPreviewImage(e){if(e&&e.type.startsWith("image/")){const t=new FileReader;t.onload=t=>{this.preview.src=t.target.result,this.preview.alt=e.name},t.readAsDataURL(e)}else this.preview.style.display="none"}}class A extends e{constructor(){super("div"),this.element.dataset.chatbotuiType="InputFileArea",document.addEventListener("chatbotuiMessageSendEvent",(()=>{this.clear()}))}clear(){this.element.innerHTML=""}getChildren(){return Array.from(this.element.children).map((e=>new F(null,null,e)))}}class L extends e{constructor(e){super("button"),this.element.innerHTML="upload",this.element.dataset.chatbotuiType="ChatFilesButton",this.element.onclick=e}getElement(){return this.element}}class k{constructor(e,t,s){this.attachFileToInput=e,this.detachFileFromInput=t,this.notifyError=s,this.inputFileArea=new A,this.chatFilesButton=new L((()=>{(async function(e){return new Promise(((t,s)=>{const i=document.createElement("input");i.type="file",i.accept=e,i.click(),i.onchange=e=>{const i=e.target.files[0];i?t(i):s(new Error("No file selected"))},i.onerror=()=>{s(new Error("File selection failed"))}}))})([".png",".jpeg",".jpg"]).then((e=>{e&&this.attachFile(e)}))})),this.chatFilesButton.element.appendChild(this.inputFileArea.element)}async attachFile(e){const t=new F(e.name,this.detachFileFromInput);this.inputFileArea.element.appendChild(t.element);try{const s=await this.attachFileToInput(e);t.setID(s),t.setPreviewImage(e)}catch(e){t.element.remove(),this.notifyError(e)}}getChatFilesButton(){return this.chatFilesButton}getInputFileArea(){return this.inputFileArea}fileTypeAllowed(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(t){for(let s of t)if(e.endsWith(s))return!0;return!1}return!0}}class B extends S{constructor(e,t,s){super(e),o(l),this.attachFileToInput=t,this.detachFileFromInput=s}_buildChatbar(){var e=this;const t=new k(this.attachFileToInput,this.detachFileFromInput,(e=>this.notifyError(e)));this.chatBar=new u((e=>this.notifyError(e)),this.streamFunction,new D(this.messageContainer,(function(){return e.documentCallbackHandler.callback(...arguments)})),t),function(e,t){function s(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover","dragleave","drop"].forEach((t=>{e.addEventListener(t,s,!1)})),["dragenter","dragover"].forEach((t=>{e.addEventListener(t,(()=>{e.dataset.chatbotuiFileDropperHighlight="true"}),!1)})),["dragleave","drop"].forEach((t=>{e.addEventListener(t,(()=>{e.dataset.chatbotuiFileDropperHighlight="false"}),!1)})),e.addEventListener("drop",(e=>{const s=e.dataTransfer.files[0];s&&t(s)}),!1)}(this.chatBar.getElement(),(e=>{t.attachFile(e)})),this.chatBar.getElement().insertBefore(t.getChatFilesButton().getElement(),this.chatBar.getChatInput().getElement())}}export{B as ChatbotUIWithFiles,y as DocumentResponse,E as MessageItemResponse,I as MessageItemResponseChunk,b as MessageItemResponseType};
