/*!
 * @license MIT
 * Copyright 2024 prognostica GmbH
 */
class t{constructor(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;s?this.element=s:(this.element=document.createElement(t),this.element.dataset.chatbotuiType="BaseComponent",this.setTimestamp(e),this.isDragging=!1,this.startX=0,this.startY=0,this.element.addEventListener("mousedown",(t=>this.onMouseDown(t))),document.addEventListener("mousemove",(t=>this.onMouseMove(t))),document.addEventListener("mouseup",(t=>this.onMouseUp(t))))}onMouseDown(t){this.isDragging=!1,this.startX=t.clientX,this.startY=t.clientY}onMouseMove(t){(Math.abs(t.clientX-this.startX)>5||Math.abs(t.clientY-this.startY)>5)&&(this.isDragging=!0)}onMouseUp(t){this.isDragging||this.toggleSelected()}toggleSelected(){this.setSelected(!this.isSelected())}setSelected(t){this.element.dataset.chatbotuiSelected=t}isSelected(){return"true"===this.element.dataset.chatbotuiSelected}setTimestamp(t){this.element.dataset.chatbotuiTimestamp=t.getTime(),this.element.dataset.chatbotuiTimestampLocale=t.toLocaleString()}}let e=t=>t;function s(t){e=t}class n extends t{static _messageCounter=0;constructor(t){super("div",arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date),this.#t(n._messageCounter++),this.element.dataset.chatbotuiType="Message",this.setRole(t)}getMessageItem(t){const e=this.element.querySelector(`[data-chatbotui-message-item-id="${t}"]`);if(e)return new i(void 0,void 0,void 0,void 0,void 0,e)}getMessageItems(){return Array.from(this.element.querySelectorAll('[data-chatbotui-type="MessageItem"]')).map((t=>new i(void 0,void 0,void 0,void 0,void 0,t)))}#t(t){this.element.dataset.chatbotuiMessageId=t}getMessageID(){return parseInt(this.element.dataset.chatbotuiMessageId,10)}setRole(t){this.element.dataset.chatbotuiMessageRole=t}getElement(){return this.element}addMessageItem(t){this.element.appendChild(t.getElement())}}class i extends t{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Date,a=arguments.length>5?arguments[5]:void 0;super("div",i,a),a||(this.#e(t),this.element.dataset.chatbotuiType="MessageItem",this.setType(e),n&&this.setName(n),this.setActive(s))}#e(t){this.id=t,this.getElement().dataset.chatbotuiMessageItemId=t}setActive(){let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];t?this.getElement().dataset.chatbotuiMessageItemActive=t:delete this.getElement().dataset.chatbotuiMessageItemActive}getElement(){return this.element}setType(t){this.element.dataset.chatbotuiMessageItemType=t}setName(t){this.element.dataset.chatbotuiMessageItemName=t}setHTML(t){this.element.innerHTML=t}setMarkdown(t){this.setHTML(e(t))}withMarkdown(t){return this.setHTML(e(t)),this}setPlaintext(t){this.element.innerText=t}withPlaintext(t){return this.setPlaintext(t),this}}let a=[];const r=t=>{for(const e of a){const s=e(t);if(s)return s}},o=t=>{if("ChatInput"===t.dataset.chatbotuiType){return t.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/div>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<[^>]+>/g,"")}};class h extends t{constructor(t,e,s){super("div"),this.element.dataset.chatbotuiType="ChatBar";const n=async()=>{if(this.isEnabled()&&!this.isRunning()){if(""!==this.getChatInput().element.innerText.trim()){this.setRunning(!0);const t=this.getInputData();document.dispatchEvent(new CustomEvent("chatbotuiMessageSendEvent")),await this.send(t),this.setRunning(!1),this.checkEnabled()}}};this.chatInput=new c(n),this.chatSendButton=new l(n),this.element.appendChild(this.chatInput.getElement()),this.element.appendChild(this.chatSendButton.getElement()),this.notifyError=t,this.createGenerator=e,this.processor=s,this.setupChatInputObserver(),this.setRunning(!1),this.setEnabled(!1)}async send(t){let e;try{e=await this.createGenerator(t)}catch(t){return console.error(t),void this.notifyError("Failed to send message.")}const s=t["chat-input"];this.processor.processUserMessage(s);try{await this.processor.process(e)}catch(t){return console.error(t),void this.notifyError("Failure during message processing.")}}getChatInput(){return this.chatInput}setRunning(t){this.getElement().dataset.chatbotuiRunning=t}isRunning(){return"true"===this.getElement().dataset.chatbotuiRunning}getChatSendButton(){return this.chatSendButton}setEnabled(t){this.getChatSendButton().getElement().disabled=!t}isEnabled(){return!this.getChatSendButton().getElement().disabled}checkEnabled(){const t=!this.isRunning(),e=""!==this.getChatInput().getElement().innerText.trim();this.setEnabled(t&&e)}setupChatInputObserver(){new MutationObserver((()=>this.checkEnabled())).observe(this.getChatInput().getElement(),{childList:!0,subtree:!0,characterData:!0})}getElement(){return this.element}getInputData(){const t={};for(const e of this.element.querySelectorAll("[data-chatbotui-type]")){const s=r(e);s&&(t[e.dataset.chatbotuiType.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()]=s)}return t}}class c extends t{constructor(t){super("div"),this.element.onkeydown=e=>{"Enter"!==e.code||e.shiftKey||(e.preventDefault(),t())},document.addEventListener("chatbotuiMessageSendEvent",(()=>{this.clear()})),this.element.contentEditable=!0,new MutationObserver((()=>{!this.element.innerHTML.endsWith("<br><br>")&&this.element.innerHTML.endsWith("<br>")&&(this.element.innerHTML=this.element.innerHTML.slice(0,-4),this.#s())})).observe(this.element,{childList:!0,characterData:!0,subtree:!0}),this.element.addEventListener("paste",(t=>{t.preventDefault();const e=t.clipboardData||window.clipboardData;if(e){const t=e.getData("text/plain"),s=window.getSelection();if(!s.rangeCount)return;const n=s.getRangeAt(0);n.deleteContents();const i=document.createTextNode(t);n.insertNode(i),n.setStartAfter(i),s.removeAllRanges(),s.addRange(n)}})),this.element.dataset.chatbotuiType="ChatInput"}clear(){this.element.innerHTML=""}#s(){this.element.focus();const t=this.element.ownerDocument.createRange();t.selectNodeContents(this.element),t.collapse(!1);const e=this.element.ownerDocument.defaultView.getSelection();e.removeAllRanges(),e.addRange(t)}getElement(){return this.element}}class l extends t{constructor(t){super("button"),this.element.innerHTML="send",this.element.dataset.chatbotuiType="ChatSendButton",this.element.onclick=t}getElement(){return this.element}}class d{constructor(){this.callbacks=new Set}register(t){if("function"!=typeof t)throw new Error("Callback must be a function");this.callbacks.add(t)}unregister(t){this.callbacks.delete(t)}callback(){for(var t=arguments.length,e=new Array(t),s=0;s<t;s++)e[s]=arguments[s];this.callbacks.forEach((t=>{try{t(...e)}catch(t){console.error("Callback error:",t)}}))}}const u=Object.freeze({TEXT:"text",TOOL:"tool",B64IMAGE:"b64image"});class m{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"N/A";this.type=t,this.content=e,this.messageItemID=s,this.type!==u.TEXT&&(this.name=n)}static fromJSON(t){const{content:e,messageItemID:s,type:n,name:i}=t;return new m(n,e,s,i)}}class g{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:u.TEXT,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.content=t,this.messageItemID=e,this.type=s,this.type!==u.TEXT&&(this.name=n)}static fromJSON(t){const{type:e,content:s,messageItemID:n,name:i}=t;return new g(s,n,e,i)}}class p{constructor(t,e,s){this.title=t,this.content=e,this.icon=s}static fromJSON(t){const{title:e,content:s,icon:n}=t;return new p(e,s,n)}}const b=(t,e)=>((t,e)=>{let s,n;return function(){for(var i=arguments.length,a=new Array(i),r=0;r<i;r++)a[r]=arguments[r];n?(clearTimeout(s),s=setTimeout((()=>{Date.now()-n>=e&&(t(...a),n=Date.now())}),e-(Date.now()-n))):(t(...a),n=Date.now())}})((()=>{t.getBoundingClientRect().bottom<=(window.innerHeight||document.documentElement.clientHeight)+2||e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}),250);class w{constructor(t,e){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.messageID=t,this.icon=s,this.title=n,this.content=e}}class v{constructor(t,e){this.messageContainer=t,this.documentCallback=e,this.scrollDown=b(t,t.parentElement)}processUserMessage(t){const e=new n("user");e.addMessageItem(new i("text").withPlaintext(t)),this.messageContainer.appendChild(e.getElement())}async process(t){const e=new n("assistant");this.messageContainer.appendChild(e.getElement()),this.scrollDown();try{await this.#n(e,t)}catch(t){const s=new i("error","text",!1);throw s.setMarkdown("*Error with response. Please try again later.*"),e.addMessageItem(s),this.#i(e),t}this.#i(e)}#i(t){t.getMessageItems().forEach((t=>{t.setActive(!1)})),this.scrollDown()}async#n(t,e){let s=null,n="";for await(const a of e){switch(a.constructor){case m:if(t.getMessageItem(a.messageItemID))throw new Error("Item already exists");case g:{const e=a.type===u.TOOL?a.name??"N/A":void 0;let r=t.getMessageItem(a.messageItemID);r||(r=new i(a.messageItemID,a.type,!0,e),r.setSelected(!0),n="",s&&s.setActive(!1),s=r,t.addMessageItem(r)),n+=a.content,r.setMarkdown(n);break}case p:{const e=new w(t.getMessageID(),a.content,a.icon,a.title);this.documentCallback(e);break}default:console.warn("Unknown data type received:",a)}this.scrollDown()}}}class I{static singleton=null;constructor(t){var e;this.setStreamFunction(t),this.documentCallbackHandler=new d,this.errorCallbackHandler=new d,e=o,a.push(e),I.singleton=this}setRender(t){s(t)}withRender(t){return this.setRender(t),this}withSessionID(t){return this.sessionID=t,this}withStreamFunction(t){return this.streamFunction=t,this}setStreamFunction(t){this.streamFunction=t}withDocumentCallback(t){return this.documentCallbackHandler.register(t),this}withErrorCallback(t){return this.errorCallbackHandler.register(t),this}notifyError(t){this.errorCallbackHandler.callback(t)}_buildChatbar(){var t=this;this.chatBar=new h((t=>this.notifyError(t)),this.streamFunction,new v(this.messageContainer,(function(){return t.documentCallbackHandler.callback(...arguments)})))}attachTo(t,e){return this.messageContainer=t,this.chatbarContainer=e,this._buildChatbar(),this.#a(),e.appendChild(this.chatBar.getElement()),this}focus(){this.chatBar.getChatInput().getElement().focus()}#a(){const t=this.chatbarContainer.dataset.chatbotuiInputPlaceholder;t&&(this.chatBar.getChatInput().getElement().dataset.chatbotuiInputPlaceholder=t)}}export{I as ChatbotUI,p as DocumentResponse,m as MessageItemResponse,g as MessageItemResponseChunk,u as MessageItemResponseType};
