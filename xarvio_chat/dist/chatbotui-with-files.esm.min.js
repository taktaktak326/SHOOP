/*!
 * @license MIT
 * Copyright 2024 prognostica GmbH
 */
class e{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"div",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;s?this.element=s:(this.element=document.createElement(e),this.element.dataset.chatbotuiType="BaseComponent",this.setTimestamp(t),this.isDragging=!1,this.startX=0,this.startY=0,this.element.addEventListener("mousedown",(e=>this.onMouseDown(e))),document.addEventListener("mousemove",(e=>this.onMouseMove(e))),document.addEventListener("mouseup",(e=>this.onMouseUp(e))))}onMouseDown(e){this.isDragging=!1,this.startX=e.clientX,this.startY=e.clientY}onMouseMove(e){(Math.abs(e.clientX-this.startX)>5||Math.abs(e.clientY-this.startY)>5)&&(this.isDragging=!0)}onMouseUp(e){this.isDragging||this.toggleSelected()}toggleSelected(){this.setSelected(!this.isSelected())}setSelected(e){this.element.dataset.chatbotuiSelected=e}isSelected(){return"true"===this.element.dataset.chatbotuiSelected}setTimestamp(e){this.element.dataset.chatbotuiTimestamp=e.getTime(),this.element.dataset.chatbotuiTimestampLocale=e.toLocaleString()}}let t=e=>e;function s(e){t=e}class n extends e{static _messageCounter=0;constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];super("div",t),this.#e(n._messageCounter++),this.element.dataset.chatbotuiType="Message",this.setRole(e),this.files=s}getMessageItem(e){const t=this.element.querySelector(`[data-chatbotui-message-item-id="${e}"]`);if(t)return new i(void 0,void 0,void 0,void 0,void 0,t)}deleteMessageItem(e){const t=this.element.querySelector(`[data-chatbotui-message-item-id="${e}"]`);return!!t&&(this.element.removeChild(t),!0)}hideMessageItem(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];const s=this.getMessageItem(e);return!!s&&(s.setHidden(t),!0)}getMessageItems(){return Array.from(this.element.querySelectorAll('[data-chatbotui-type="MessageItem"]')).map((e=>new i(void 0,void 0,void 0,void 0,void 0,e)))}#e(e){this.element.dataset.chatbotuiMessageId=e}getMessageID(){return parseInt(this.element.dataset.chatbotuiMessageId,10)}setRole(e){this.element.dataset.chatbotuiMessageRole=e}getElement(){return this.element}addMessageItem(e){this.element.appendChild(e.getElement())}displayFiles(){if(0==this.files.length)return;const e=document.createElement("div");e.className="message-file-area",this.files.forEach((t=>{e.appendChild(t.element)})),this.element.appendChild(e)}}class i extends e{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3?arguments[3]:void 0,i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:new Date,a=arguments.length>5?arguments[5]:void 0;super("div",i,a),a||(this.#t(e),this.element.dataset.chatbotuiType="MessageItem",this.setType(t),n&&this.setName(n),this.setActive(s))}#t(e){this.id=e,this.getElement().dataset.chatbotuiMessageItemId=e}setActive(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?this.getElement().dataset.chatbotuiMessageItemActive=e:delete this.getElement().dataset.chatbotuiMessageItemActive}setHidden(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];e?this.getElement().dataset.chatbotuiMessageItemHidden=e:delete this.getElement().dataset.chatbotuiMessageItemHidden}getElement(){return this.element}setType(e){this.element.dataset.chatbotuiMessageItemType=e}setName(e){this.element.dataset.chatbotuiMessageItemName=e}setHTML(e){this.element.innerHTML=e}setMarkdown(e){this.setHTML(t(e))}withMarkdown(e){return this.setHTML(t(e)),this}setPlaintext(e){this.element.innerText=e}withPlaintext(e){return this.setPlaintext(e),this}}let a=[];const r=e=>{for(const t of a){const s=t(e);if(s)return s}},o=e=>{a.push(e)},l=e=>{if("ChatInput"===e.dataset.chatbotuiType){return e.innerHTML.replace(/<br\s*\/?>/gi,"\n").replace(/<\/div>/gi,"\n").replace(/<\/p>/gi,"\n").replace(/<[^>]+>/g,"")}},h=e=>{if("InputFileArea"===e.dataset.chatbotuiType){const t=e.querySelectorAll('[data-chatbotui-type="InputFile"][data-chatbotui-input-file-id]'),s=[];for(const e of t)s.push(e.dataset.chatbotuiInputFileId);return s}};class c extends e{constructor(e,t,s){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;super("div"),this.element.dataset.chatbotuiType="ChatBar",this.sendInput=async()=>{if(this.isEnabled()&&!this.isRunning()){const e=this.getChatInput().element.innerText.trim(),t=n?n.getInputFileArea().getChildren():[];if(""!==e){this.setRunning(!0);const e=this.getInputData();document.dispatchEvent(new CustomEvent("chatbotuiMessageSendEvent")),await this.send(e,t),this.setRunning(!1),this.checkEnabled()}}},this.chatInput=new d(this.sendInput,n),this.chatSendButton=new u(this.sendInput),this.element.appendChild(this.chatInput.getElement()),this.element.appendChild(this.chatSendButton.getElement()),this.notifyError=e,this.createGenerator=t,this.processor=s,this.setupChatInputObserver(),this.setRunning(!1),this.setEnabled(!1)}async send(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const s=e["chat-input"];let n;this.processor.processUserMessage(s,t);try{n=await this.createGenerator(e)}catch(e){return console.error(e),void this.notifyError("Failed to send message.")}try{await this.processor.process(n)}catch(e){return console.error(e),void this.notifyError("Failure during message processing.")}}getChatInput(){return this.chatInput}setRunning(e){this.getElement().dataset.chatbotuiRunning=e}isRunning(){return"true"===this.getElement().dataset.chatbotuiRunning}getChatSendButton(){return this.chatSendButton}setEnabled(e){this.getChatSendButton().getElement().disabled=!e}isEnabled(){return!this.getChatSendButton().getElement().disabled}checkEnabled(){const e=!this.isRunning(),t=""!==this.getChatInput().getElement().innerText.trim();this.setEnabled(e&&t)}setupChatInputObserver(){new MutationObserver((()=>this.checkEnabled())).observe(this.getChatInput().getElement(),{childList:!0,subtree:!0,characterData:!0})}getElement(){return this.element}getInputData(){const e={};for(const t of this.element.querySelectorAll("[data-chatbotui-type]")){const s=r(t);s&&(e[t.dataset.chatbotuiType.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()]=s)}return e}}class d extends e{constructor(e,t){super("div"),this.fileHandler=t,this.isComposing=!1;let s=!1;this.element.addEventListener("keydown",(t=>{"Shift"===t.key&&(s=!0),"Enter"!==t.key||t.isComposing||s||(t.preventDefault(),e())})),this.element.addEventListener("keyup",(e=>{"Shift"===e.key&&(s=!1)})),this.element.addEventListener("compositionstart",(()=>{this.isComposing=!0})),this.element.addEventListener("compositionend",(()=>{this.isComposing=!1})),document.addEventListener("chatbotuiMessageSendEvent",(()=>{this.clear()})),this.element.contentEditable=!0,this.setupPasteHandler(),this.element.dataset.chatbotuiType="ChatInput"}setupMutationObserver(){new MutationObserver((()=>{!this.element.innerHTML.endsWith("<br><br>")&&this.element.innerHTML.endsWith("<br>")&&(this.element.innerHTML=this.element.innerHTML.slice(0,-4),this.#s())})).observe(this.element,{childList:!0,characterData:!0,subtree:!0})}setupPasteHandler(){this.element.addEventListener("paste",(async e=>{e.preventDefault();const t=e.clipboardData||window.clipboardData;if(!t)return;const s=t.getData("text/plain");if(s){const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0);t.deleteContents();const n=document.createTextNode(s);t.insertNode(n),t.setStartAfter(n),e.removeAllRanges(),e.addRange(t)}if(this.fileHandler){const e=t.items;for(let t=0;t<e.length;t++){const s=e[t].getAsFile();s&&this.fileHandler.attachFile(s)}}}))}clear(){this.element.innerHTML=""}#s(){this.element.focus();const e=this.element.ownerDocument.createRange();e.selectNodeContents(this.element),e.collapse(!1);const t=this.element.ownerDocument.defaultView.getSelection();t.removeAllRanges(),t.addRange(e)}getElement(){return this.element}}class u extends e{constructor(e){super("button"),this.element.innerHTML="send",this.element.dataset.chatbotuiType="ChatSendButton",this.element.onclick=e}getElement(){return this.element}}class m{constructor(){this.callbacks=new Set}register(e){if("function"!=typeof e)throw new Error("Callback must be a function");this.callbacks.add(e)}unregister(e){this.callbacks.delete(e)}callback(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];this.callbacks.forEach((e=>{try{e(...t)}catch(e){console.error("Callback error:",e)}}))}}const g=Object.freeze({TEXT:"text",TOOL:"tool",B64IMAGE:"b64image"});class p{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:-1,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"N/A";this.type=e,this.content=t,this.messageItemID=s,this.type!==g.TEXT&&(this.name=n)}static fromJSON(e){const{content:t,messageItemID:s,type:n,name:i}=e;return new p(n,t,s,i)}}class I{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:g.TEXT,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.content=e,this.messageItemID=t,this.type=s,this.type!==g.TEXT&&(this.name=n)}static fromJSON(e){const{type:t,content:s,messageItemID:n,name:i}=e;return new I(s,n,t,i)}}class b{constructor(e,t,s){this.title=e,this.content=t,this.icon=s}static fromJSON(e){const{title:t,content:s,icon:n}=e;return new b(t,s,n)}}class v{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;this.messageItemID=e}static fromJSON(e){const{messageItemID:t}=e;return new v(t)}}class f{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:-1;this.messageItemID=e}static fromJSON(e){const{messageItemID:t}=e;return new f(t)}}const w=e=>((e,t)=>{let s=!1;return function(){s||(s=!0,e(...arguments),setTimeout((()=>{s=!1}),t))}})((()=>{e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}),500);class E{constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";this.messageID=e,this.icon=s,this.title=n,this.content=t}}class y{constructor(e,t){this.messageContainer=e,this.documentCallback=t,this.scrollDown=w(e,e.parentElement)}processUserMessage(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];const s=new n("user",new Date,t);s.addMessageItem(new i("text").withPlaintext(e)),s.displayFiles(),this.messageContainer.appendChild(s.getElement())}async process(e){const t=new n("assistant");this.messageContainer.appendChild(t.getElement()),this.scrollDown();try{await this.#n(t,e)}catch(e){const s=new i("error","text",!1);throw s.setMarkdown("*Error with response. Please try again later.*"),t.addMessageItem(s),this.#i(t),e}this.#i(t)}#i(e){e.getMessageItems().forEach((e=>{e.setActive(!1)})),setTimeout((()=>this.scrollDown()),500)}async#n(e,t){let s=null,n="";for await(const a of t){switch(a.constructor){case p:if(e.getMessageItem(a.messageItemID))throw new Error("Item already exists");case I:{const t=a.type===g.TOOL?a.name??"N/A":void 0;let r=e.getMessageItem(a.messageItemID);r||(r=new i(a.messageItemID,a.type,!0,t),r.setSelected(!0),n="",s&&s.setActive(!1),s=r,e.addMessageItem(r)),n+=a.content,r.setMarkdown(n);break}case b:{const t=new E(e.getMessageID(),a.content,a.icon,a.title);this.documentCallback(t);break}case v:e.deleteMessageItem(a.messageItemID);case f:e.hideMessageItem(a.messageItemID);default:console.warn("Unknown data type received:",a)}this.scrollDown()}}}class C{static singleton=null;constructor(e){this.setStreamFunction(e),this.documentCallbackHandler=new m,this.errorCallbackHandler=new m,o(l),C.singleton=this}setRender(e){s(e)}withRender(e){return this.setRender(e),this}withSessionID(e){return this.sessionID=e,this}withStreamFunction(e){return this.streamFunction=e,this}setStreamFunction(e){this.streamFunction=e}withDocumentCallback(e){return this.documentCallbackHandler.register(e),this}withErrorCallback(e){return this.errorCallbackHandler.register(e),this}notifyError(e){this.errorCallbackHandler.callback(e)}_buildChatbar(){var e=this;this.chatBar=new c((e=>this.notifyError(e)),this.streamFunction,new y(this.messageContainer,(function(){return e.documentCallbackHandler.callback(...arguments)})))}attachTo(e,t){return this.messageContainer=e,this.chatbarContainer=t,this._buildChatbar(),this.#a(),t.appendChild(this.chatBar.getElement()),this}focus(){this.chatBar.getChatInput().getElement().focus()}sendInput(){this.chatBar.sendInput()}#a(){const e=this.chatbarContainer.dataset.chatbotuiInputPlaceholder;e&&(this.chatBar.getChatInput().getElement().dataset.chatbotuiInputPlaceholder=e)}}class M extends e{constructor(e,t,s){super("div",void 0,s),s||(this.element.dataset.chatbotuiType="InputFile",this.setName(e),this.element.onclick=e=>{e.stopPropagation(),this.element.dataset.chatbotuiInputFileId&&(t(this.element.dataset.chatbotuiInputFileId),this.element.remove())},this.preview=document.createElement("img"),this.preview.classList.add("file-preview"),this.element.insertBefore(this.preview,this.element.firstChild))}setName(e){this.element.dataset.chatbotuiInputFileName=e}setID(e){this.element.dataset.chatbotuiInputFileId=e}setPreviewImage(e){if(e&&e.type.startsWith("image/")){const t=new FileReader;t.onload=t=>{this.preview.src=t.target.result,this.preview.alt=e.name},t.readAsDataURL(e)}else this.preview.style.display="none"}}class F extends e{constructor(){super("div"),this.element.dataset.chatbotuiType="InputFileArea",document.addEventListener("chatbotuiMessageSendEvent",(()=>{this.clear()}))}clear(){this.element.innerHTML=""}getChildren(){return Array.from(this.element.children).map((e=>new M(null,null,e)))}}class T extends e{constructor(e,t,s){super("button"),this.notifyError=s,this.element.innerHTML="upload",this.element.dataset.chatbotuiType="ChatFilesButton",this.attachFileToInput=e,this.detachFileFromInput=t,this.inputFileArea=new F,this.element.appendChild(this.inputFileArea.element),this.element.onclick=()=>{(async function(e){return new Promise(((t,s)=>{const n=document.createElement("input");n.type="file",n.accept=e,n.click(),n.onchange=e=>{const n=e.target.files[0];n?t(n):s(new Error("No file selected"))},n.onerror=()=>{s(new Error("File selection failed"))}}))})(".png").then((e=>{this.attachFile(e)}))}}async attachFile(e){const t=new M(e.name,this.detachFileFromInput);this.inputFileArea.element.appendChild(t.element);try{const s=await this.attachFileToInput(e);t.setID(s)}catch(e){t.element.remove(),this.notifyError("Failed to attach file.")}}getElement(){return this.element}}class D extends C{constructor(e,t,s){super(e),o(h),this.attachFileToInput=t,this.detachFileFromInput=s}_buildChatbar(){var e=this;const t=new k(this.attachFileToInput,this.detachFileFromInput,(e=>this.notifyError(e)));this.chatBar=new c((e=>this.notifyError(e)),this.streamFunction,new y(this.messageContainer,(function(){return e.documentCallbackHandler.callback(...arguments)})),t),function(e,t){function s(e){e.preventDefault(),e.stopPropagation()}["dragenter","dragover","dragleave","drop"].forEach((t=>{e.addEventListener(t,s,!1)})),["dragenter","dragover"].forEach((t=>{e.addEventListener(t,(()=>{e.dataset.chatbotuiFileDropperHighlight="true"}),!1)})),["dragleave","drop"].forEach((t=>{e.addEventListener(t,(()=>{e.dataset.chatbotuiFileDropperHighlight="false"}),!1)})),e.addEventListener("drop",(e=>{const s=e.dataTransfer.files[0];s&&t(s)}),!1)}(this.chatBar.getElement(),(e=>{t.attachFile(e)})),this.chatBar.getElement().insertBefore(t.getChatFilesButton().getElement(),this.chatBar.getChatInput().getElement())}}class k{constructor(e,t,s){this.attachFileToInput=e,this.detachFileFromInput=t,this.notifyError=s,this.chatFilesButton=new T(this),this.inputFileArea=this.chatFilesButton.inputFileArea}async attachFile(e){const t=new M(e.name,this.detachFileFromInput);this.inputFileArea.element.appendChild(t.element);try{const s=await this.attachFileToInput(e);t.setID(s),t.setPreviewImage(e)}catch(e){t.element.remove(),this.notifyError(e)}}getChatFilesButton(){return this.chatFilesButton}getInputFileArea(){return this.inputFileArea}fileTypeAllowed(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(t){for(let s of t)if(e.endsWith(s))return!0;return!1}return!0}}export{D as ChatbotUIWithFiles,b as DocumentResponse,p as MessageItemResponse,I as MessageItemResponseChunk,g as MessageItemResponseType};
